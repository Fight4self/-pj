name: CI/CD Pipeline

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  # é•œåƒåç§°ï¼Œæ ¼å¼: dockerhubç”¨æˆ·å/é•œåƒå
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/flask-demo-app

jobs:
  # æ„å»ºå¹¶æ¨é€é•œåƒ
  
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # è®¾ç½® Docker Buildx (æ„å»ºå¤šå¹³å°é•œåƒçš„å·¥å…·)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç™»å½• Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ„å»ºå¹¶æ¨é€
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}:latest

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨ (Deploy)
  deploy:
    needs: build-and-push # åªæœ‰æ„å»ºæˆåŠŸæ‰æ‰§è¡Œéƒ¨ç½²
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          # è‹¥ ssh ç«¯å£ä¸æ˜¯ 22ï¼Œå¯æ·»åŠ  port: 2222
          script: |
            set -e
            
            # å®šä¹‰å˜é‡ï¼šæ ¹æ®å½“å‰åˆ†æ”¯åå†³å®š å®¹å™¨å å’Œ ç«¯å£
            # å¦‚æœæ˜¯ main åˆ†æ”¯,å®¹å™¨å flask-app, ç«¯å£ 5000
            # å¦‚æœæ˜¯ dev åˆ†æ”¯,å®¹å™¨å flask-app-dev, ç«¯å£ 5001
            
            BRANCH_NAME=${{ github.ref_name }}
            
            if [ "$BRANCH_NAME" == "main" ]; then
              CONTAINER_NAME="flask-app"
              PORT=5000
            else
              CONTAINER_NAME="flask-app-dev"
              PORT=5001
            fi
            
            echo "ğŸš€ Deploying branch: $BRANCH_NAME to Port: $PORT"
            
            # åœæ­¢å¹¶åˆ é™¤å¯¹åº”çš„æ—§å®¹å™¨
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true
            
            # å¯åŠ¨æ–°å®¹å™¨ (æ³¨æ„è¿™é‡Œä½¿ç”¨äº†å˜é‡)
            docker pull ${{ env.IMAGE_NAME }}:latest
            
            docker run -d \
              --name $CONTAINER_NAME \
              --restart always \
              -p $PORT:5000 \
              ${{ env.IMAGE_NAME }}:latest
            
            # æ¸…ç†æ— ç”¨çš„æ—§é•œåƒ
            docker image prune -f
  # ç»™é’‰é’‰å‘æ¶ˆæ¯
  notify:
      needs: deploy
      runs-on: ubuntu-latest
      if: always()
      steps:
        # ä¸‹è½½ä»£ç 
        - name: Checkout repository code
          uses: actions/checkout@v4
        # å› ä¸ºè¿™é‡Œéœ€è¦ notify-.sh è„šæœ¬ï¼Œå‘é€é’‰é’‰é€šçŸ¥
        - name: Dingtalk Notification
          env:
            WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK }}
            COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
            ACTOR: ${{ github.actor }}
            REF_NAME: ${{ github.ref_name }}
            SENDER_LOGIN: ${{ github.event.sender.login }}
            EVENET_NAME: ${{ github.event_name }}
            EVENT_REPOSITORY_PUSHED_AT: ${{github.event.repository.pushed_at}}
            DEPLOY_RESULT: ${{ needs.deploy.result }}
            # main åˆ†æ”¯è®¿é—®åœ°å€
            SERVER_URL_main: http://59.110.53.164:5000
            # dev åˆ†æ”¯è®¿é—®åœ°å€
            SERVER_URL_dev: http://59.110.53.164:5001
            # é»˜è®¤ä½¿ç”¨ main è®¿é—®åœ°å€
            SERVER_URL: http://59.110.53.164:5000
          run: |
              # 1. ç»™è„šæœ¬èµ‹äºˆæ‰§è¡Œæƒé™
              chmod +x ./scripts/dingtalk-notify.sh

              # 2. è¿è¡Œè„šæœ¬
              ./scripts/dingtalk-notify.sh

          