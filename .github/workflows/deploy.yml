name: CI/CD Pipeline

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  # é•œåƒåç§°ï¼Œæ ¼å¼: dockerhubç”¨æˆ·å/é•œåƒå
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/flask-demo-app

jobs:
  # æ„å»ºå¹¶æ¨é€é•œåƒ
  
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # è®¾ç½® Docker Buildx (æ„å»ºå¤šå¹³å°é•œåƒçš„å·¥å…·)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç™»å½• Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ„å»ºå¹¶æ¨é€
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}:latest

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨ (Deploy)
  deploy:
    needs: build-and-push # åªæœ‰æ„å»ºæˆåŠŸæ‰æ‰§è¡Œéƒ¨ç½²
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          # è‹¥ ssh ç«¯å£ä¸æ˜¯ 22ï¼Œå¯æ·»åŠ  port: 2222
          script: |
            set -e
            
            # å®šä¹‰å˜é‡ï¼šæ ¹æ®å½“å‰åˆ†æ”¯åå†³å®š å®¹å™¨å å’Œ ç«¯å£
            # å¦‚æœæ˜¯ main åˆ†æ”¯,å®¹å™¨å flask-app, ç«¯å£ 5000
            # å¦‚æœæ˜¯ dev åˆ†æ”¯,å®¹å™¨å flask-app-dev, ç«¯å£ 5001
            
            BRANCH_NAME=${{ github.ref_name }}
            
            if [ "$BRANCH_NAME" == "main" ]; then
              CONTAINER_NAME="flask-app"
              PORT=5000
            else
              CONTAINER_NAME="flask-app-dev"
              PORT=5001
            fi
            
            echo "ğŸš€ Deploying branch: $BRANCH_NAME to Port: $PORT"
            
            # åœæ­¢å¹¶åˆ é™¤å¯¹åº”çš„æ—§å®¹å™¨
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true
            
            # å¯åŠ¨æ–°å®¹å™¨ (æ³¨æ„è¿™é‡Œä½¿ç”¨äº†å˜é‡)
            docker pull ${{ env.IMAGE_NAME }}:latest
            
            docker run -d \
              --name $CONTAINER_NAME \
              --restart always \
              -p $PORT:5000 \
              ${{ env.IMAGE_NAME }}:latest
            
            # æ¸…ç†æ— ç”¨çš„æ—§é•œåƒ
            docker image prune -f
  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Dingtalk Notification
        env:
          WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          DEPLOY_RESULT: ${{ needs.deploy.result }}
          SERVER_URL: http://59.110.53.164:5000
        run: |
          # 1. å˜é‡èµ‹å€¼
          STATUS="${{ needs.deploy.result }}"
          # 2. åˆ¤æ–­é€»è¾‘
          if [ "$STATUS" = "success" ]; then 
            TITLE="âœ… éƒ¨ç½²æˆåŠŸ"
          else
            TITLE="âŒ éƒ¨ç½²å¤±è´¥"
          fi

          # 3. æ„å»º Markdown å†…å®¹
          MARKDOWN_TEXT="# ${TITLE} 
            **é¡¹ç›®**: -pj 

            **æäº¤ä¿¡æ¯**: ${COMMIT_MESSAGE} 

            **è®¿é—®åœ°å€**: [ç‚¹å‡»è®¿é—®](${SERVER_URL})  
            
            > æ¥è‡ª GitHub Actions è‡ªåŠ¨åŒ–æµæ°´çº¿"
          # 4. æ„é€  JSON è´Ÿè½½
          JSON_PAYLOAD=$(jq -n \
            --arg msgtype "markdown" \
            --arg title "GitHub Actions" \
            --arg text "$MARKDOWN_TEXT" \
            '{msgtype: $msgtype, markdown: {title: $title, text: $text}}')
          # 5. å‘é€è¯·æ±‚
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"   

          